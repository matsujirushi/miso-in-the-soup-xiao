#include <Wire.h>
#include "TouchSensorClass.hpp"
#include <FastLED.h>
#include "VibrationMotorClass.hpp"

static constexpr int MOTOR_F_PIN = D3;
static constexpr int MOTOR_R_PIN = D2;
static constexpr int SLED_PIN = D8;
static constexpr int SLED_NUMBER = 60;

static constexpr int SENSOR_ADDRESS = 0x37;

static const unsigned char SENSOR_CONFIG[128] = {
  0xE3u, 0x01u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u,
  0x00u, 0x00u, 0x00u, 0x00u, 0x80u, 0x80u, 0x7Fu, 0x7Fu,
  0x7Fu, 0x80u, 0x80u, 0x80u, 0x80u, 0x7Fu, 0x00u, 0x00u,
  0x00u, 0x00u, 0x00u, 0x00u, 0x03u, 0x00u, 0x00u, 0x00u,
  0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x80u,
  0x05u, 0x00u, 0x00u, 0x02u, 0x00u, 0x02u, 0x00u, 0x00u,
  0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x1Eu, 0x1Eu, 0x00u,
  0x00u, 0x1Eu, 0x1Eu, 0x00u, 0x00u, 0x00u, 0x01u, 0x01u,
  0x00u, 0xFFu, 0xFFu, 0xFFu, 0xFFu, 0xFFu, 0x00u, 0x00u,
  0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x03u, 0x01u, 0x58u,
  0x00u, 0x37u, 0x06u, 0x00u, 0x00u, 0x0Au, 0x00u, 0x00u,
  0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u,
  0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u,
  0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u,
  0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u,
  0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x25u, 0xDFu
};

static TouchSensorClass TouchSensor{ SENSOR_ADDRESS };
static CRGB Leds[SLED_NUMBER];
static VibrationMotorClass VibrationMotor{ MOTOR_F_PIN, MOTOR_R_PIN };

void setup(void) {
  Serial.begin(115200);
  Wire.begin();

  delay(1000);

  TouchSensor.begin(SENSOR_CONFIG);
  FastLED.addLeds<SK6812, SLED_PIN, GRB>(Leds, std::size(Leds));
  VibrationMotor.begin();
}

void loop(void) {
  TouchSensor.capture();
  Serial.printf("%3u %3u %3u %3u\n", TouchSensor.getValue(0), TouchSensor.getValue(1), TouchSensor.getValue(2), TouchSensor.getValue(3));

  for (int i = 0; i < 5; i++) {
    Leds[i] = (TouchSensor.getValue(0) << 16) + (TouchSensor.getValue(1) << 8) + TouchSensor.getValue(2);
  }
  FastLED.show();

  if (TouchSensor.getValue(0) == 255 && TouchSensor.getValue(1) == 255 && TouchSensor.getValue(2) == 255) {
    VibrationMotor.turnOn();
  } else if (TouchSensor.getValue(0) == 0 && TouchSensor.getValue(1) == 0 && TouchSensor.getValue(2) == 0) {
    VibrationMotor.turnOff();
  }

  delay(100);
}
